<?php

/**/
$fixoJson = '{
    "xmlRetorno": "<?xml version=\"1.0\"?><retorno><nome_arquivo>B0002508.211</nome_arquivo><hd h17=\"0001\" h16=\"\" h15=\"4309308\" h14=\"043\" h13=\"\" h12=\"0000\" h11=\"0002\" h10=\"0002\" h09=\"0002\" h08=\"001311\" h07=\"CRT\" h06=\"BFO\" h05=\"SDT\" h04=\"25082021\" h03=\"XXXXX XX XXXXXXXXXXXX XXXXX XXXX XXXX\" h02=\"XXX\" h01=\"0\"/>\r\n&gt;\r\n<tr t52=\"0002\" t51=\"\" t50=\"0000000000\" t49=\"\" t48=\"\" t47=\"\" t46=\"\" t45=\"000\" t44=\"000000000000000\" t43=\"00000\" t42=\"0000000000\" t41=\"P\" t40=\"\" t39=\"ERMO\" t38=\"\" t37=\"0\" t36=\"D\" t35=\"\" t34=\"25082021\" t33=\"\" t32=\"8590311\" t31=\"1\" t30=\"RS\" t29=\"GUAIBA\" t28=\"92500000\" t27=\"R S GERALDO LJ,0000,,\" t26=\"00000000000000\" t25=\"00000000000000\" t24=\"001\" t23=\"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX\" t22=\"1\" t21=\"N\" t20=\"\" t19=\"GUAIBA\" t18=\"00000000110557\" t17=\"00000000110557\" t16=\"001\" t15=\"12042021\" t14=\"11032021\" t13=\"3007652574\" t12=\"DMI\" t11=\"3007652574\" t10=\"SP\" t09=\"SAO PAULO\" t08=\"04551000\" t07=\"R. OLIMPIADAS, 000 - 12 AND\" t06=\"00000000000000\" t05=\"XXXXX XX XXXXXXXXXXXX XXXXX XXXX XXXX\" t04=\"XXXXX XX XXXXXXXXXXXX XXXXX XXXX XXXX\" t03=\"AEP1912209998\" t02=\"XXX\" t01=\"1\"/><tr t52=\"0003\" t51=\"\" t50=\"0000000000\" t49=\"\" t48=\"\" t47=\"\" t46=\"\" t45=\"000\" t44=\"000000000000000\" t43=\"00000\" t42=\"0000000000\" t41=\"P\" t40=\"\" t39=\"ERMO\" t38=\"\" t37=\"0\" t36=\"D\" t35=\"\" t34=\"25082021\" t33=\"\" t32=\"8590320\" t31=\"1\" t30=\"RS\" t29=\"GUAIBA\" t28=\"92500000\" t27=\"R S GERALDO LJ,0000,,\" t26=\"00000000000\" t25=\"10912198000133\" t24=\"001\" t23=\"XXXXXXXXXXXXXXXXXXXXXXXXXXXXX\" t22=\"1\" t21=\"N\" t20=\"\" t19=\"GUAIBA\" t18=\"00000000231123\" t17=\"00000000231123\" t16=\"001\" t15=\"27042021\" t14=\"26032021\" t13=\"3007859018\" t12=\"DMI\" t11=\"3007859018\" t10=\"SP\" t09=\"SAO PAULO\" t08=\"04551000\" t07=\"R. OLIMPIADAS, 100 - 12 AND\" t06=\"61940292000137\" t05=\"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX\" t04=\"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX\" t03=\"AEP1912209998\" t02=\"AEP\" t01=\"1\"/><tl t08=\"0004\" t07=\"\" t06=\"000000000000341680\" t05=\"00006\" t04=\"25082021\" t03=\"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX\" t02=\"AEP\" t01=\"9\"/></retorno>",
    "jsonSoapResponse": {
        "@version": "1.0",
        "retorno": {
            "nome_arquivo": "B0002508.211",
            "hd": {
                "@h17": "0001",
                "@h16": "",
                "@h15": "4309308",
                "@h14": "043",
                "@h13": "",
                "@h12": "0000",
                "@h11": "0002",
                "@h10": "0002",
                "@h09": "0002",
                "@h08": "001311",
                "@h07": "CRT",
                "@h06": "BFO",
                "@h05": "SDT",
                "@h04": "25082021",
                "@h03": "XXXXX XX XXXXXXXXXXXX XXXXX XXXX XXXX",
                "@h02": "XXX",
                "@h01": "0"
            },
            "tr": {
                "@t52": "0002",
                "@t51": "",
                "@t50": "0000000000",
                "@t49": "",
                "@t48": "",
                "@t47": "",
                "@t46": "",
                "@t45": "000",
                "@t44": "000000000000000",
                "@t43": "00000",
                "@t42": "0000000000",
                "@t41": "P",
                "@t40": "",
                "@t39": "ERMO",
                "@t38": "",
                "@t37": "0",
                "@t36": "D",
                "@t35": "",
                "@t34": "25082021",
                "@t33": "",
                "@t32": "8590311",
                "@t31": "1",
                "@t30": "RS",
                "@t29": "GUAIBA",
                "@t28": "92500000",
                "@t27": "R S GERALDO LJ,0000,,",
                "@t26": "00000000000000",
                "@t25": "00000000000000",
                "@t24": "001",
                "@t23": "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
                "@t22": "1",
                "@t21": "N",
                "@t20": "",
                "@t19": "GUAIBA",
                "@t18": "00000000110557",
                "@t17": "00000000110557",
                "@t16": "001",
                "@t15": "12042021",
                "@t14": "11032021",
                "@t13": "3007652574",
                "@t12": "DMI",
                "@t11": "3007652574",
                "@t10": "SP",
                "@t09": "SAO PAULO",
                "@t08": "04551000",
                "@t07": "R. OLIMPIADAS, 000 - 12 AND",
                "@t06": "00000000000000",
                "@t05": "XXXXX XX XXXXXXXXXXXX XXXXX XXXX XXXX",
                "@t04": "XXXXX XX XXXXXXXXXXXX XXXXX XXXX XXXX",
                "@t03": "AEP1912209998",
                "@t02": "XXX",
                "@t01": "1"
            },
            "tr": {
                "@t52": "0003",
                "@t51": "",
                "@t50": "0000000000",
                "@t49": "",
                "@t48": "",
                "@t47": "",
                "@t46": "",
                "@t45": "000",
                "@t44": "000000000000000",
                "@t43": "00000",
                "@t42": "0000000000",
                "@t41": "P",
                "@t40": "",
                "@t39": "ERMO",
                "@t38": "",
                "@t37": "0",
                "@t36": "D",
                "@t35": "",
                "@t34": "25082021",
                "@t33": "",
                "@t32": "8590320",
                "@t31": "1",
                "@t30": "RS",
                "@t29": "GUAIBA",
                "@t28": "92500000",
                "@t27": "R S GERALDO LJ,0000,,",
                "@t26": "00000000000",
                "@t25": "10912198000133",
                "@t24": "001",
                "@t23": "XXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
                "@t22": "1",
                "@t21": "N",
                "@t20": "",
                "@t19": "GUAIBA",
                "@t18": "00000000231123",
                "@t17": "00000000231123",
                "@t16": "001",
                "@t15": "27042021",
                "@t14": "26032021",
                "@t13": "3007859018",
                "@t12": "DMI",
                "@t11": "3007859018",
                "@t10": "SP",
                "@t09": "SAO PAULO",
                "@t08": "04551000",
                "@t07": "R. OLIMPIADAS, 100 - 12 AND",
                "@t06": "61940292000137",
                "@t05": "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
                "@t04": "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
                "@t03": "AEP1912209998",
                "@t02": "AEP",
                "@t01": "1"
            },
            "tl": {
                "@t08": "0004",
                "@t07": "",
                "@t06": "000000000000341680",
                "@t05": "00006",
                "@t04": "25082021",
                "@t03": "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
                "@t02": "AEP",
                "@t01": "9"
            }
        }
    },
    "nome_arquivo": "BY741801.221",
    "soapFault": {}
}
';

/***/

    $Entrada = $jsonEntrada;
     
    //ar_dump($Entrada);


    $conteudoEntrada = array("dadosEntrada" => $Entrada["dadosEntrada"][0]);

    //var_dump($conteudoEntrada);
    $conteudoFormatado = json_encode($conteudoEntrada);
    
    $service_url = 'http://172.19.130.11:5555/gateway/lebesIEPRO/1.0/protestos/confirmacao';


    $curl = curl_init($service_url);
    curl_setopt($curl, CURLOPT_CUSTOMREQUEST, "POST");
    curl_setopt($curl, CURLOPT_POSTFIELDS, $conteudoFormatado);
    curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($curl, CURLOPT_CONNECTTIMEOUT, 0);
    curl_setopt($curl, CURLOPT_TIMEOUT, 120); //timeout in seconds
    curl_setopt($curl, CURLOPT_FAILONERROR, true); // Required for HTTP error codes to be reported via our call to curl_error($ch)
    curl_setopt($curl, CURLOPT_HTTPHEADER, array(
      'Content-Type: application/json',
      'Content-Length: ' . strlen($conteudoFormatado))
    );
//    curl_setopt($curl, CURLOPT_HEADER, true);
//    curl_setopt($curl, CURLOPT_FOLLOWLOCATION, 1);
    curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false);
    $curl_response = curl_exec($curl);
    $info = curl_getinfo($curl);

    $erro = null;
    if (curl_errno($curl)) {
        $errno= curl_errno($curl);
        $erro = curl_error($curl);
    }
    curl_close($curl); // close cURL handler
    
    $retorno = json_decode($curl_response,true);


   // var_dump($retorno);

    $jsonEntrada = $retorno;

    $jsonEntrada = json_decode($fixoJson, true);
    
    $operacao = "";
   $confirmacao = $jsonEntrada["jsonSoapResponse"]["confirmacao"];
   if (isset($confirmacao)) {
    $operacao = "confirmacao";
   }
   $confirmacao = $jsonEntrada["jsonSoapResponse"]["retorno"];
   if (isset($confirmacao)) {
    $operacao = "retorno";
   }
   
    $new = simplexml_load_string($jsonEntrada["xmlRetorno"]);

// Convert into json
    $con = json_encode($new);
    
// Convert into associative array
$newArr = json_decode($con, true);
  

$arrayhd = $newArr["hd"]["@attributes"];
$arraytl = $newArr["tl"]["@attributes"];
$valor   = $newArr["tr"];

$arraytr = array();
foreach($valor as $indice2 => $valor2)
{
    //echo "  (2)  -- ".$indice2." -> ".$valor2."\n";
    
    foreach($valor2 as $indice3 => $valor3)
                {
                   //echo "   (3) -- --- ".$indice3." -> ".$valor3."\n";
                    if (!is_array($valor3)){
             
                        $arraytr[0][$indice3] = $valor3;
                    }
            foreach($valor3 as $indice4 => $valor4)
            {
                //echo "  (4) -- --- --- ".$seqindice."-".$indice4." -> ".$valor4."\n";
                if (!is_array($valor4)){
                // if (!$valor4==""){
                        $arraytr[$indice2][$indice4] = $valor4;
                // }
                }
            }
        }

}

$array = array();
$array = array("jsonSoapResponse" =>array(array(
                    "operacao" => $operacao)),
               "hd" => array($arrayhd),
               "tr" => $arraytr,
               "tl" => array($arraytl));

//echo json_encode($arraytr);
//var_dump($newArr);
/**
    $array = array();
    $array["jsonSoapResponse"] = array(array(
                        "operacao" => $operacao));
    $seqindice = 0;
    foreach($newArr as $indice => $valor)
    {
           echo " (1) ".$indice." -> ".$valor."\n";
            if (!is_array($valor)){
                $array["jsonSoapResponse"] = array(array(
                    "operacao" => $operacao,
                    $indice => $valor));
             //   $array[$indice] = $valor;
            }
            if ($indice=="hd"){
                $nomeindice = "hd";
                $array[$nomeindice]= array();
            }
            if ($indice=="tr"){
               // $seqindice = $seqindice + 1;
                $nomeindice = "tr";
                $array[$nomeindice][$seqindice] = array();
            }
            if ($indice=="tl"){
                $nomeindice = "tl";
                $array[$nomeindice] = array();
            }

            foreach($valor as $indice2 => $valor2)
            {
                echo "  (2)  -- ".$indice2." -> ".$valor2."\n";

                if (!is_array($valor2)){
             
                    $array[$nomeindice][0][$indice2] = $valor2;
                } {
                    if ($indice2<>"@attributes"){
                        $seqindice = $indice2;
                    }
                    
                }
    
                foreach($valor2 as $indice3 => $valor3)
                {
                    echo "   (3) -- --- ".$indice3." -> ".$valor3."\n";
                    if (!is_array($valor3)){
             
                        $array[$nomeindice][0][$indice3] = $valor3;
                    }
    
                    foreach($valor3 as $indice4 => $valor4)
                    {
                        echo "  (4) -- --- --- ".$seqindice."-".$indice4." -> ".$valor4."\n";
                        if (!is_array($valor4)){
                           // if (!$valor4==""){
                                $array[$nomeindice][$seqindice][$indice4] = $valor4;
                           // }
                        }
                    }
                  
                }
            }
            //var_dump($indice, $valor);
    }

  **/  
    
    $dados["dadosEntrada"] = array($array); 
    

    $jsonSaida = $dados;
    
?>
